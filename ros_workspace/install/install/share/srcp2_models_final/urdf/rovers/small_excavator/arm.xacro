<?xml version="1.0"?>
<!--
	Space Robotics Challenge Phase 2
	NASA-JSC
	Copyright (c) 2021, All Rights Reserved
	Unauthorized distribution strictly prohibited

    @brief excavator arm for the small exavator robot. All the connections,
           bolts and settings (note: motors are in motors.gazebo)
    ________________________________________________________________________

    Degrees of Freedom:

                 2: elbow pitch joint      3: wrist pitch joint
        
                          O =============== O = [scoop-link]
                         //   radial link
            humerus     //
            link       //  
                       O      1: shoulder pitch joint
                     /   \
                    /     \
                   =========
        shoulder   |       |  0: shoulder yaw joint
        link       =========
                 _____________
                  mount-link

    All links, joints, collisions and visuals are defined here, although
    the joints are simply left as free rotations (motors are connected
    centrally)
-->

<robot xmlns:xacro="http://ros.org/wiki/xacro">

    <xacro:macro name="arm" params="chassis_name rover_name">

        <!--
        ________________________________________________________________________________________________________________
		Joint and Physics Tuning Constants

        Note: motors are in this robot's motors.gazebo file 
		-->

        <xacro:property name="ground_collision_bitmask" value="0x01" /> <!-- hexadecimal -->

        <xacro:property name="shoulder_yaw_velocity_limit" value="0.5" />  <!-- rad/sec -->
        <xacro:property name="shoulder_yaw_effort_limit"   value="500" />  <!-- Nm -->
        <xacro:property name="shoulder_yaw_damping"        value="2.0" />  <!-- Nm/rad/sec -->
        <xacro:property name="shoulder_yaw_friction"       value="1.0" />  <!-- Nm/rad -->
    
        <xacro:property name="shoulder_pitch_velocity_limit" value="0.5" />       <!-- rad/sec -->
        <xacro:property name="shoulder_pitch_effort_limit"   value="500" />       <!-- Nm -->
        <xacro:property name="shoulder_pitch_damping"        value="2.0" />       <!-- Nm/rad/sec -->
        <xacro:property name="shoulder_pitch_friction"       value="0.5" />       <!-- Nm/rad -->
        <xacro:property name="shoulder_pitch_upper_limit" value="${3*pi/8.0}" />  <!-- rad -->
        <xacro:property name="shoulder_pitch_lower_limit" value="${-3*pi/8.0}" /> <!-- rad -->

        <xacro:property name="elbow_pitch_velocity_limit" value="0.5" />          <!-- rad/sec -->
        <xacro:property name="elbow_pitch_effort_limit"   value="500" />          <!-- Nm -->
        <xacro:property name="elbow_pitch_damping"        value="2.0" />          <!-- Nm/rad/sec -->
        <xacro:property name="elbow_pitch_friction"       value="0.5" />          <!-- Nm/rad -->
        <xacro:property name="elbow_pitch_upper_limit"    value="${7*pi/8}" />  <!-- rad -->
        <xacro:property name="elbow_pitch_lower_limit"    value="${-pi/4}"/>      <!-- rad -->

        <xacro:property name="wrist_pitch_velocity_limit" value="0.5" />       <!-- rad/sec -->
        <xacro:property name="wrist_pitch_effort_limit"   value="500" />       <!-- Nm -->
        <xacro:property name="wrist_pitch_damping"        value="2.0" />       <!-- Nm/rad/sec -->
        <xacro:property name="wrist_pitch_friction"       value="1.0" />       <!-- Nm/rad -->
        <xacro:property name="wrist_pitch_upper_limit"    value="${2*pi/3}" /> <!-- rad -->
        <xacro:property name="wrist_pitch_lower_limit"    value="${-2*pi/3}" />         <!-- rad -->
        
        <!--
        ________________________________________________________________________________________________________________
		Links and Joints 
		-->

        <!-- Arm Mounting Block -->
        <link name="${rover_name}_arm_mount">
            <visual name="${rover_name}_arm_mount_visual">
				<origin xyz="0 0 0" rpy="0 0 ${pi/2.0}"/>
                <geometry>
                    <mesh
                        filename = "package://srcp2_models_final/meshes/arms/small/mount.dae"
                        scale    = "0.4 0.4 0.4"/>
                </geometry>
            </visual>

            <collision name="${rover_name}_arm_mount_collision">
                <origin xyz="0.5 0 -0.1" rpy="0 0 0"/>
                <geometry>
                    <box size="0.3 0.3 0.1"/>
                </geometry>
            </collision>

            <inertial>
                <mass value = "5.0"/>
                <xacro:box_inertia
                    m = "5.0"
                    x = "0.3"
                    y = "0.3"
                    z = "0.3" />
            </inertial>
        </link>

        <!-- Bolt the arm mount to the chassis -->
        <joint name="arm_mount_joint" type="fixed">
            <parent link="${chassis_name}"/>
            <child  link="${rover_name}_arm_mount"/>
        </joint>

		<!-- Shoulder Link -->
		<link name="${rover_name}_shoulder">
			<visual name="${rover_name}_shoulder_visual">
				<geometry>
					<mesh
						filename = "package://srcp2_models_final/meshes/arms/small/shoulder.dae"
						scale    = "0.15 0.15 0.15"/>
				</geometry>
			</visual>

			<collision name="${rover_name}_shoulder_collision">
				<geometry>
					<cylinder
						radius = "0.05"
						length = "0.05"/>
				</geometry>
			</collision>

			<inertial>
				<mass value = "1.0"/>
				<xacro:cylinder_inertia
					m = "1.0"
					h = "0.15"
					r = "0.33" />
			</inertial>
		</link>
    
		<!-- Shoulder Yaw Joint -->
		<joint name="shoulder_yaw_joint" type="continuous">
			<parent link = "${rover_name}_arm_mount"/>
			<child  link = "${rover_name}_shoulder"/>
			<origin xyz="0.7 0.0 0.1" rpy="0 0 0"/>
			<axis 
				xyz = "0 0 1"
				rpy = "0 0 0"/>
			<limit
				effort   = "${shoulder_yaw_effort_limit}"
				velocity = "${shoulder_yaw_velocity_limit}" />
			<dynamics
				damping  = "${shoulder_yaw_damping}"
				friction = "${shoulder_yaw_friction}" />
		</joint>

        <!-- 
            Arm humerus bone;
            this includes the graphics of both the shoulder-ptich and
            elbow joints
        -->
		<link name="${rover_name}_humerus">
            <self_collide>true</self_collide>

			<visual name="${rover_name}_humerus_visual">
				<origin xyz="0 0.05 0" rpy="0 0 ${pi/2.0}"/>
				<geometry>
					<mesh
						filename = "package://srcp2_models_final/meshes/arms/small/humerus.dae"
						scale    = "0.08 0.08 0.08"/>
				</geometry>
			</visual>

			<collision name="${rover_name}_humerus_collision">
				<origin xyz="0.35 0.05 0" rpy="0 ${pi/2.0} 0"/>
				<geometry>
					<cylinder
						radius = "0.05"
						length = "0.6"/>
				</geometry>
			</collision>

			<inertial>
				<origin xyz="0.35 0.05 0" rpy="0 ${pi/2.0} 0"/>
				<mass value = "0.5"/>
				<xacro:cylinder_inertia
					m = "0.5"
					h = "0.6"
					r = "0.02" />
			</inertial>
		</link>

		<!-- Shoulder Pitch Joint -->
		<joint name="shoulder_pitch_joint" type="revolute">
			<parent link = "${rover_name}_shoulder"/>
			<child  link = "${rover_name}_humerus"/>
			<origin xyz="0.19 0 0.12" rpy="0 0 0"/>
			<axis
				xyz = "0 1 0"
				rpy = "0 0 0"/>
			<limit
				effort   = "${shoulder_pitch_effort_limit}"
				velocity = "${shoulder_pitch_velocity_limit}"
				lower    = "${shoulder_pitch_lower_limit}"
				upper    = "${shoulder_pitch_upper_limit}" />

			<dynamics
				damping  = "${shoulder_pitch_damping}"
				friction = "${shoulder_pitch_friction}" /> 
		</joint>

		<!-- Arm radius bone -->
		<link name="${rover_name}_radius">
			<visual name="${rover_name}_radius_visual">
				<origin xyz="0 -0.05 0" rpy="0 ${pi} ${pi/2.0}"/>
				<geometry>
					<mesh
						filename = "package://srcp2_models_final/meshes/arms/small/radius.dae"
						scale    = "0.08 0.08 0.08" />
				</geometry>
			</visual>

			<collision name="${rover_name}_radius_collision">
				<origin xyz="0.35 -0.05 0" rpy="0 ${pi/2.0} 0"/>
				<geometry>
					<cylinder
						radius = "0.05"
						length = "0.6"/>
				</geometry>
			</collision>
	
    		<inertial>
				<origin xyz="0.35 -0.05 0" rpy="0 ${pi/2.0} 0"/>
				<mass value = "0.5"/>
				<xacro:cylinder_inertia
					m = "0.5"
					h = "0.6"
					r = "0.05" />
			</inertial>
		</link>

        <!-- Elbow Pitch Joint -->
		<joint name="elbow_pitch_joint" type="revolute">
			<parent link = "${rover_name}_humerus"/>
			<child  link = "${rover_name}_radius"/>
			<origin xyz="0.8 0.0 0.0" rpy="0 0 0"/>
			<axis
				xyz = "0 1 0"
				rpy = "0 0 0"/>
			<limit
				effort   = "${elbow_pitch_effort_limit}"
				velocity = "${elbow_pitch_velocity_limit}"
				upper    = "${elbow_pitch_upper_limit}"
				lower    = "${elbow_pitch_lower_limit}" />
			<dynamics
				damping  = "${elbow_pitch_damping}"
				friction = "${elbow_pitch_friction}" />
 		</joint>

        <!-- Scoop (end effector) Link -->
        <link name="${rover_name}_scoop">
            <collision name="${rover_name}_scoop_collision">
				<origin xyz="0.02 0.05 0" rpy="0 ${pi} ${pi/2.0}"/>
                <geometry>
                    <mesh
                        filename = "package://srcp2_models_final/meshes/arms/small/scoop.dae"
                        scale    = "0.2 0.1 0.1"/>
                </geometry>
            </collision>

            <visual name="${rover_name}_scoop_visual">
				<origin xyz="0.02 0.05 0" rpy="0 ${pi} ${pi/2.0}"/>
                <geometry>
                    <mesh
                        filename = "package://srcp2_models_final/meshes/arms/small/scoop.dae"
                        scale    = "0.2 0.1 0.1"/>
                </geometry>
            </visual>
        
            <inertial>
				<origin xyz="0.02 0.05 0" rpy="0 ${pi} ${pi/2.0}"/>
                <mass value = "0.25"/>
                <xacro:box_inertia
                    m = "0.25"
                    x = "0.33"
                    y = "0.25"
                    z = "0.15" />
            </inertial>
        </link>

        <!-- Wrist Pitch Joint -->
		<joint name="wrist_pitch_joint" type="revolute">
			<parent link = "${rover_name}_radius"/>
			<child  link = "${rover_name}_scoop"/>
			<origin xyz="0.8 0.0 0.0" rpy="0 0 0"/>
			<axis
				xyz = "0 1 0"
				rpy = "0 0 0"/>
			<limit
				effort   = "${wrist_pitch_effort_limit}"
				velocity = "${wrist_pitch_velocity_limit}"
				upper    = "${wrist_pitch_upper_limit}"
                lower    = "${wrist_pitch_lower_limit}" />
			<dynamics
				damping  = "${wrist_pitch_damping}"
				friction = "${wrist_pitch_friction}" />
		</joint>


        <!-- this link exists to give the clods something safe to spawn in -->
		<!-- that is guaranteed to be inside the scoop bowl -->
		<link name="${rover_name}_scoop_spawn_zone">

			<collision name="${rover_name}_scoop_spawn_zone_col">
    			<origin xyz="0.22 0.05 0.05" rpy="0 0 0"/>
				<geometry>
					<box size="0.26 0.15 0.15"/>
				</geometry>
			</collision>
			
			<inertial>
    			<origin xyz="0.22 0.05 0.05" rpy="0 0 0"/>
                <mass value = "0.05"/>
                <xacro:box_inertia
                    m = "0.05"
                    x = "0.15"
                    y = "0.30"
                    z = "0.15" />
			</inertial>
		</link>

        <joint name="spawning_zone_joint" type="revolute">
			<parent link="${rover_name}_scoop"/>
			<child  link="${rover_name}_scoop_spawn_zone"/>
			<axis   xyz="0 0 1"/>
            <limit
                upper = "0"
                lower = "0"
                effort = "1e9"
                velocity="0"/>
		</joint>

        <!-- <gazebo>
            <joint name="spawning_zone_joint" type="fixed">
                <parent>scoop</parent>
                <child>scoop_spawn_zone</child>
                <axis>0 0 1</axis>
            </joint>
        </gazebo> -->

        <!--
            Because URDF has no (or few) native physics tags, we have to 
            post-hoc add Gazebo physics bitmasking here
        -->
        <gazebo reference="${rover_name}_scoop">
            <!-- for debug reasons, this has been made red. comment this to restore default colors -->
            <material>Gazebo/Red</material> 
            <collision>
                <surface>
                    <contact>
                        <collide_bitmask>${ground_collision_bitmask}</collide_bitmask>
                    </contact>
                </surface>
            </collision>
            <selfCollide>true</selfCollide>
        </gazebo>
        
        <gazebo reference="${rover_name}_radius">
            <collision>
                <surface>
                    <contact>
                        <collide_bitmask>${ground_collision_bitmask}</collide_bitmask>
                    </contact>
                </surface>
            </collision>
            <selfCollide>true</selfCollide>
        </gazebo>

        <!-- this links should be invisible to everything -->
        <gazebo reference="${rover_name}_scoop_spawn_zone">
            <collision>
                <surface>
					<contact>
						<collide_bitmask>0x00</collide_bitmask>
					</contact>
				</surface>
            </collision>
        </gazebo>

        <gazebo reference="${rover_name}_arm_mount">
            <selfCollide>true</selfCollide>
        </gazebo>

        <gazebo reference="${rover_name}_shoulder">
            <selfCollide>true</selfCollide>
        </gazebo>        

        <gazebo reference="${rover_name}_humerus">
            <selfCollide>true</selfCollide>
        </gazebo>
            
        <gazebo reference="elbow_pitch_joint">
            <provideFeedback>true</provideFeedback>
        </gazebo>

        <gazebo reference="shoulder_pitch_joint">
            <provideFeedback>true</provideFeedback>
        </gazebo>

        <gazebo reference="shoulder_yaw_joint">
            <provideFeedback>true</provideFeedback>
        </gazebo>

        <gazebo reference="wrist_pitch_joint">
            <provideFeedback>true</provideFeedback>
        </gazebo>

        <!-- Spoil spawning is generated on a per-robot basis -->
        <gazebo>
            <plugin name="spoil_spawner" filename="libSpoilSpawner.so">
                <ignore_ground>false</ignore_ground>
                <scoop_link_name>${rover_name}_scoop</scoop_link_name>
                <spawn_zone_link_name>${rover_name}_scoop_spawn_zone</spawn_zone_link_name>
                <heightmap_name>heightmap</heightmap_name>
                <heightmap_collision_name>collision_heightmap</heightmap_collision_name>
                <clod_radius>0.05</clod_radius>
                <max_capacity>5</max_capacity>
                <max_volatile_radius>4.0</max_volatile_radius>
                <min_volatile_depth>2.0</min_volatile_depth>
                <max_volatile_depth>17.0</max_volatile_depth>
            </plugin>
        </gazebo>


    </xacro:macro>
</robot>
